<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>El Guardi√°n del Escudo Digital</title>
<style>
  /* ==========================
     ESTILOS GENERALES (UI)
     Todo en un solo archivo, sin dependencias externas.
     Dirigido a ni√±os de 8-9 a√±os: colores claros, botones grandes, texto legible.
     ========================== */
  :root{
    --bg:#0e1220;             /* Fondo nocturno para resaltar proyectiles */
    --panel:#12182c;          /* Paneles */
    --accent:#00bcd4;         /* Azul cian para acentos */
    --good:#35d07f;           /* Verde √©xito */
    --warn:#ffb300;           /* Amarillo advertencia */
    --danger:#ff5252;         /* Rojo peligro */
    --text:#e9f0ff;           /* Texto principal */
    --muted:#a9b3d1;
    --shield:#7c4dff;         /* Color de escudo base */
    --shield2:#00e5ff;        /* Skin 2 */
    --shield3:#ff4081;        /* Skin 3 */
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0b1022 0%, #0c1230 60%, #0e152f 100%);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
    color:var(--text);
    display:flex; flex-direction:column; gap:8px;
  }
  header{
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 12px; background:var(--panel); border-bottom:1px solid #1b2242;
    position:sticky; top:0; z-index:5;
  }
  header .title{
    display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.2px;
  }
  header .badge{font-size:12px; padding:4px 8px; border-radius:999px; background:#1b2242; color:var(--muted)}
  header .controls{display:flex; align-items:center; gap:8px}
  .btn{
    border:none; border-radius:12px; padding:10px 14px; font-size:14px; font-weight:700; cursor:pointer;
    background:#1a2142; color:var(--text); box-shadow: 0 0 0 1px #24306b inset; transition: transform .05s ease;
  }
  .btn:active{ transform: translateY(1px) }
  .btn.primary{ background: linear-gradient(180deg,#1e3f73,#102a52); box-shadow:0 0 0 1px #3a67b8 inset }
  .btn.good{ background: linear-gradient(180deg,#0e6b45,#0a4b31); box-shadow:0 0 0 1px #1dc77b inset }
  .btn.warn{ background: linear-gradient(180deg,#a06a0a,#6e4807); box-shadow:0 0 0 1px #ffc045 inset }
  .btn.danger{ background: linear-gradient(180deg,#7a1034,#4e0a22); box-shadow:0 0 0 1px #ff6a8f inset }
  .btn.small{ padding:8px 10px; font-size:12px }

  main{
    display:grid; grid-template-columns: minmax(240px,1fr) 2.2fr minmax(240px,1fr);
    gap:12px; padding:8px 12px; flex:1;
  }
  .panel{ background:var(--panel); border:1px solid #1b2242; border-radius:var(--radius); padding:10px; }

  /* Panel izquierdo: Briefing/Tutorial */
  #briefing{ display:flex; flex-direction:column; gap:8px }
  #briefing h2{ margin:0 0 4px 0; font-size:18px }
  #briefing .card{ background:#111836; border:1px solid #1c2753; border-radius:12px; padding:10px }
  #briefing .tip{ font-size:13px; color:var(--muted) }
  #voiceToggle{ margin-left:6px }

  /* Panel central: Juego (Canvas) */
  #gameWrap{ position:relative; overflow:hidden; }
  #gameCanvas{ width:100%; height:420px; background: radial-gradient(120% 100% at 50% 100%, #0a1030 0%, #0c143c 40%, #0d1746 80%); border-radius:12px; display:block; }
  /* HUD sobre el canvas */
  #hud{ position:absolute; inset:8px; display:flex; align-items:flex-start; justify-content:space-between; pointer-events:none }
  #waveBadge{ background:#12193b; border:1px solid #223077; border-radius:10px; padding:6px 8px; font-size:12px; opacity:.95 }
  #statusText{ font-size:13px; color:var(--muted) }
  #centerMsg{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); pointer-events:none; text-align:center; font-weight:800; text-shadow:0 2px 12px rgba(0,0,0,.5)}
  #centerMsg .big{ font-size:28px }
  #centerMsg .mid{ font-size:16px; color:var(--muted) }

  /* Panel derecho: Escudo de la Calma + Personalizaci√≥n */
  #shieldPanel{ display:flex; flex-direction:column; gap:10px }
  .shieldBar{
    background:#0f1638; border:1px solid #1b2553; border-radius:12px; padding:10px;
  }
  .barWrap{ background:#0c1430; border-radius:10px; height:18px; overflow:hidden; border:1px solid #1a244f }
  .barFill{ height:100%; background:linear-gradient(90deg,var(--good), #8bf0c0); width:100%; transition:width .25s ease }
  .shieldIcon{ font-size:28px }
  .skinGrid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px }
  .skin{
    border:2px solid #25306a; border-radius:12px; height:40px; cursor:pointer; position:relative;
    background: conic-gradient(from 0deg, var(--shield) 0 120deg, #1c1e5a 120deg 360deg);
  }
  .skin[data-skin="base"]{ background: radial-gradient(80% 80% at 50% 50%, var(--shield) 0%, #2b2d7f 60%, #1a1c55 100%) }
  .skin[data-skin="ice"]{ background: radial-gradient(80% 80% at 50% 50%, var(--shield2) 0%, #1a8fb3 60%, #124b66 100%) }
  .skin[data-skin="rose"]{ background: radial-gradient(80% 80% at 50% 50%, var(--shield3) 0%, #a11f56 60%, #5a0f31 100%) }
  .skin.locked{ filter:grayscale(.9); opacity:.6; cursor:not-allowed }
  .skin::after{ content:attr(data-name); position:absolute; inset:auto 6px 4px 6px; font-size:10px; color:#c9d2ff; text-shadow:0 1px 0 #111 }

  /* Barra inferior: Defensas */
  #defenses{ display:flex; gap:10px; }
  #defenses .btn{ flex:1; font-size:18px; display:flex; align-items:center; justify-content:center; gap:8px; padding:14px }
  #defenses kbd{ background:#0c1331; border:1px solid #2a376c; padding:2px 6px; border-radius:6px; font-size:12px; color:#a9b3d1 }

  /* Di√°logos y modales */
  dialog{ border:none; border-radius:16px; background:#0f1533; color:var(--text); width:min(720px, 92vw); padding:14px 16px; }
  dialog::backdrop{ background:rgba(7,10,24,.6) }
  .modalHeader{ display:flex; align-items:center; justify-content:space-between; margin-bottom:6px }
  .modalHeader h3{ margin:0; font-size:20px }
  .modalBody{ display:grid; gap:10px }
  .modalFooter{ display:flex; justify-content:flex-end; gap:8px; margin-top:6px }
  .list{ margin:0; padding-left:18px }

  /* Accesibilidad de foco */
  :focus-visible{ outline:2px solid #64b5f6; outline-offset:2px }

  /* Peque√±as adaptaciones responsive */
  @media (max-width: 980px){
    main{ grid-template-columns: 1fr; }
    #gameCanvas{ height: 360px }
  }
</style>
</head>
<body>
  <header>
    <div class="title">
      <span style="font-size:22px">üõ°Ô∏è El Guardi√°n del Escudo Digital</span>
      <span class="badge">3¬∞ Primaria ¬∑ Offline</span>
    </div>
    <div class="controls">
      <button id="btnTutorial" class="btn">üìò Tutorial</button>
      <button id="btnReiniciar" class="btn">üîÑ Reiniciar</button>
      <label class="btn small" title="Activar/Desactivar narraci√≥n">
        üîä Voz
        <input id="voiceToggle" type="checkbox" checked style="margin-left:6px" />
      </label>
    </div>
  </header>

  <main>
    <!-- Briefing / Tutorial lateral -->
    <section id="briefing" class="panel">
      <h2>üë®‚Äçüè´ Maestro de la Serenidad</h2>
      <div class="card">
        <p style="margin-top:0">Recuerda tus tres defensas:</p>
        <ul class="list">
          <li><b>Ignorar üí®</b>: Para burlas menores. No responderlas las hace desaparecer.</li>
          <li><b>Bloquear üõ°Ô∏è</b>: Para <i>acoso persistente</i>. Corta la comunicaci√≥n.</li>
          <li><b>Avisar üö®</b>: Para <i>amenazas o solicitudes peligrosas</i>. Pide ayuda a un adulto.</li>
        </ul>
        <p class="tip">Usa el teclado: <kbd>1</kbd> Ignorar, <kbd>2</kbd> Bloquear, <kbd>3</kbd> Avisar.</p>
      </div>
      <div class="card">
        <b>Modo extra</b>: <i>Avalancha Infinita</i> ‚Äî velocidad creciente y puntuaci√≥n.
        <div style="margin-top:8px; display:flex; gap:8px">
          <button id="btnAvalancha" class="btn primary">üå™Ô∏è Iniciar Avalancha</button>
          <button id="btnPausa" class="btn">‚è∏Ô∏è Pausa</button>
        </div>
      </div>
      <div class="card">
        <b>M√©tricas</b>
        <div style="font-size:13px" id="metrics">‚Äî</div>
      </div>
    </section>

    <!-- Centro: Juego (Canvas + HUD) -->
    <section id="gameWrap" class="panel">
      <canvas id="gameCanvas" width="960" height="540" aria-label="Zona de juego"></canvas>
      <div id="hud">
        <div>
          <div id="waveBadge">Oleada <span id="waveNo">0</span> / 3</div>
          <div id="statusText">Preparado</div>
        </div>
        <div id="centerMsg" aria-live="polite"></div>
      </div>
      <div id="defenses" style="margin-top:10px">
        <button id="btnIgnorar" class="btn good" aria-label="Ignorar (tecla 1)">üí® Ignorar <kbd>1</kbd></button>
        <button id="btnBloquear" class="btn warn" aria-label="Bloquear (tecla 2)">üõ°Ô∏è Bloquear <kbd>2</kbd></button>
        <button id="btnAvisar" class="btn danger" aria-label="Avisar a un adulto (tecla 3)">üö® Avisar <kbd>3</kbd></button>
      </div>
    </section>

    <!-- Derecha: Escudo + Personalizaci√≥n -->
    <aside id="shieldPanel" class="panel">
      <div class="shieldBar">
        <div style="display:flex; align-items:center; justify-content:space-between">
          <div><span class="shieldIcon">üßò</span> Escudo de la Calma</div>
          <div id="hpLabel">100%</div>
        </div>
        <div class="barWrap" aria-hidden="true"><div id="hpBar" class="barFill"></div></div>
      </div>
      <div class="card">
        <b>Personalizaci√≥n del escudo</b>
        <div class="skinGrid" id="skinGrid">
          <div class="skin" data-skin="base" data-name="Base"></div>
          <div class="skin locked" data-skin="ice" data-name="Hielo ‚ùÑÔ∏è" title="Supera Oleada 1"></div>
          <div class="skin locked" data-skin="rose" data-name="Rosa üåπ" title="Supera Oleada 2"></div>
        </div>
      </div>
      <div class="card" style="font-size:13px; color:var(--muted)">
        <b>Frase de poder</b>:
        <div style="margin-top:6px">‚ÄúIgnoro, bloqueo o pido favor, de mi calma digital soy el protector‚Äù.</div>
      </div>
    </aside>
  </main>

  <!-- Modal Tutorial -->
  <dialog id="tutorial">
    <div class="modalHeader">
      <h3>üìò Bienvenido, Guardi√°n</h3>
      <button class="btn small" onclick="this.closest('dialog').close()">‚úñ</button>
    </div>
    <div class="modalBody">
      <p>El Maestro de la Serenidad dice:</p>
      <ul class="list">
        <li><b>Ignorar üí®</b>: Para <b>burlas simples</b> (p.ej., ‚ÄúTu avatar es feo‚Äù).</li>
        <li><b>Bloquear üõ°Ô∏è</b>: Para <b>acoso persistente</b> (insultos repetidos).</li>
        <li><b>Avisar üö®</b>: Para <b>amenazas</b> o <b>solicitudes sospechosas</b> (datos, fotos, contrase√±as).</li>
      </ul>
      <p>Defiende tu calma: usa los botones o el teclado (<kbd>1</kbd>, <kbd>2</kbd>, <kbd>3</kbd>).</p>
      <details>
        <summary><b>Oleadas</b></summary>
        <ol class="list">
          <li><b>Principiante</b>: Burlas simples y lentas. Respuesta: <b>Ignorar</b>.</li>
          <li><b>Intermedio</b>: Aparece un acosador persistente. Respuesta: <b>Bloquear</b> (e ignorar burlas simples).</li>
          <li><b>Avanzado</b>: Amenazas y solicitudes peligrosas. Respuesta: <b>Avisar</b> (y aplicar las otras cuando correspondan).</li>
        </ol>
      </details>
    </div>
    <div class="modalFooter">
      <button class="btn primary" onclick="this.closest('dialog').close(); window.startGame()">¬°Comenzar!</button>
    </div>
  </dialog>

  <!-- Modal Fin de Partida -->
  <dialog id="endModal">
    <div class="modalHeader">
      <h3 id="endTitle">Resultado</h3>
      <button class="btn small" onclick="this.closest('dialog').close()">‚úñ</button>
    </div>
    <div class="modalBody" id="endBody"></div>
    <div class="modalFooter">
      <button class="btn" onclick="this.closest('dialog').close()">Cerrar</button>
      <button class="btn primary" onclick="window.startGame()">Jugar de nuevo</button>
    </div>
  </dialog>

<script>
/* =============================================================
   EL GUARDI√ÅN DEL ESCUDO DIGITAL ‚Äî Juego de una sola p√°gina
   HTML+CSS+JS en un √∫nico archivo. Sin dependencias. Offline.

   Mec√°nica principal:
   - Proyectiles (mensajes) caen desde arriba hacia el avatar.
   - El jugador reacciona con una de tres defensas: Ignorar, Bloquear, Avisar.
   - Cada tipo de proyectil exige una defensa espec√≠fica.
   - 3 Oleadas guiadas (tutorializado) + Modo infinito.

   Accesibilidad:
   - Botones grandes y atajos (1,2,3)
   - Mensajes por voz (speechSynthesis) con interruptor.
   - Texto claro y m√©trica final.

   Audio:
   - Sonidos simples generados con WebAudio (sin ficheros externos).
   - L√≠neas de voz en espa√±ol reproducidas con speechSynthesis.

   Autor: Dise√±ado para uso educativo.
   ============================================================= */
(() => {
  // ---------------------- Utilidades generales ----------------------
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const rand = (a,b)=>Math.random()*(b-a)+a;
  const choice = arr => arr[(Math.random()*arr.length)|0];

  // ---------------------- Lienzo (Canvas) ----------------------
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  function fitCanvasToCSS() {
    // Ajusta el tama√±o interno al tama√±o visible para nitidez
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0); // Escala l√≥gica
  }
  fitCanvasToCSS();
  window.addEventListener('resize', fitCanvasToCSS);

  // ---------------------- Estado del juego ----------------------
  const State = {
    running: false,
    paused: false,
    mode: 'campaign', // 'campaign' | 'infinite'
    wave: 0,
    hp: 100,
    shieldSkin: 'base',
    unlocks: { ice:false, rose:false },
    score: 0,
    metrics: { ignored:0, blocked:0, reported:0, mistakes:0 },
    projectiles: [],
    spawnTimer: 0,
    bullyActive: false, // indica si hay acoso persistente en curso
    elapsed: 0
  };

  // Mensajes por tipo
  const MSG = {
    TAUNT: [
      'Tu avatar es feo', 'Qu√© lento eres', 'Jaja, qu√© mal juegas', 'No puedes ganar', 'Pfff, aburrido'
    ],
    BULLY_LOOP: [
      'Perdedor', 'Perdedor...', 'Te gan√© siempre', 'Nadie te quiere', 'Siempre pierdes'
    ],
    DANGER: [
      'M√°ndame una foto tuya', 'Dame tu contrase√±a para proteger tu cuenta', 'Te encontrar√© en la escuela', 'P√°same tu direcci√≥n', 'M√°ndame tu n√∫mero'
    ]
  };

  // Par√°metros de oleadas (campa√±a)
  const WAVES = [
    // Oleada 1 ‚Äì solo burlas simples
    {
      name:'Principiante',
      duration: 22000,
      spawnEvery: 1400,
      speed: 85,
      types: ['taunt']
    },
    // Oleada 2 ‚Äì taunts + bully persistente
    {
      name:'Intermedio',
      duration: 26000,
      spawnEvery: 1200,
      speed: 105,
      types: ['taunt','bully']
    },
    // Oleada 3 ‚Äì incluye peligros
    {
      name:'Avanzado',
      duration: 30000,
      spawnEvery: 1100,
      speed: 125,
      types: ['taunt','bully','danger']
    }
  ];

  // ---------------------- UI elementos ----------------------
  const hpBar = document.getElementById('hpBar');
  const hpLabel = document.getElementById('hpLabel');
  const waveNo = document.getElementById('waveNo');
  const statusText = document.getElementById('statusText');
  const centerMsg = document.getElementById('centerMsg');
  const metricsDiv = document.getElementById('metrics');
  const skinGrid = document.getElementById('skinGrid');

  // ---------------------- Audio: WebAudio + Voz ----------------------
  const AC = new (window.AudioContext || window.webkitAudioContext)();
  const voiceEnabled = () => document.getElementById('voiceToggle').checked;

  function speak(text){
    if(!voiceEnabled()) return;
    // Usa speechSynthesis nativo; parametrizaci√≥n simple.
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'es-MX';
    u.rate = 1; u.pitch = 1.05; u.volume = 1;
    speechSynthesis.cancel(); // evitar cola larga
    speechSynthesis.speak(u);
  }

  // Sonidos b√°sicos sintetizados
  function beep(freq=440, time=0.15, type='sine', gain=0.03){
    const o=AC.createOscillator(); const g=AC.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g).connect(AC.destination);
    o.start(); o.stop(AC.currentTime+time);
  }
  function wind(){ // Ignorar correcto: ruido de viento suave
    const noise = AC.createBufferSource();
    const buffer = AC.createBuffer(1, AC.sampleRate*0.25, AC.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1) * (1-i/data.length); // fade-out
    noise.buffer = buffer;
    const filt = AC.createBiquadFilter(); filt.type='highpass'; filt.frequency.value=600;
    const g=AC.createGain(); g.gain.value=0.04;
    noise.connect(filt).connect(g).connect(AC.destination);
    noise.start();
  }
  function wall(){ // Bloqueo: golpe grave + chispa
    beep(110,0.12,'square',0.05); setTimeout(()=>beep(220,0.08,'sawtooth',0.03),60);
  }
  function reinforcements(){ // Avisar: mini fanfarria
    [523,659,784].forEach((f,i)=>setTimeout(()=>beep(f,0.12,'triangle',0.05), i*120));
  }
  function impact(){ // Error
    beep(98,0.2,'sawtooth',0.05);
  }

  // ---------------------- Entidades ----------------------
  const PLAYER = { x:0, y:0, r:34 };

  function resetPlayerPos(){
    const w = canvas.clientWidth; const h = canvas.clientHeight;
    PLAYER.x = w/2; PLAYER.y = h*0.76; PLAYER.r = Math.max(28, Math.min(40, Math.min(w,h)*0.04));
  }
  resetPlayerPos();

  // Projectile factory
  function makeProjectile(kind){
    const w = canvas.clientWidth; const startX = rand(40, w-40);
    const speed = (State.mode==='infinite')? (120 + State.elapsed*0.02) : WAVES[State.wave-1].speed;
    const radius = kind==='danger'? 26 : (kind==='bully'? 20 : 16);
    let text = '';
    if(kind==='taunt') text = choice(MSG.TAUNT);
    else if(kind==='bully'){ text = choice(MSG.BULLY_LOOP); State.bullyActive = true; }
    else if(kind==='danger') text = choice(MSG.DANGER);
    return {
      id: Math.random().toString(36).slice(2),
      kind, text,
      x: startX, y: -30,
      vy: speed/60,
      r: radius,
      alive: true,
      from: (kind==='bully'? 'acosador' : 'fuente')
    };
  }

  // ---------------------- Dibujo ----------------------
  function drawShieldBase(){
    const {x,y,r} = PLAYER;
    // Aura seg√∫n skin
    ctx.save();
    let grad = ctx.createRadialGradient(x,y,r*0.2, x,y,r*1.25);
    const skin = State.shieldSkin;
    if(skin==='ice') { grad.addColorStop(0,'rgba(0,229,255,0.55)'); grad.addColorStop(1,'rgba(26,143,179,0)'); }
    else if(skin==='rose') { grad.addColorStop(0,'rgba(255,64,129,0.55)'); grad.addColorStop(1,'rgba(161,31,86,0)'); }
    else { grad.addColorStop(0,'rgba(124,77,255,0.55)'); grad.addColorStop(1,'rgba(43,45,127,0)'); }
    ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(x,y,r*1.4,0,Math.PI*2); ctx.fill();

    // Disco del escudo
    ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fillStyle = skin==='ice'? '#00e5ff33' : (skin==='rose'? '#ff408133' : '#7c4dff33');
    ctx.fill();
    ctx.strokeStyle = skin==='ice'? '#9be8ff' : (skin==='rose'? '#ffc4d8' : '#c9bdff');
    ctx.stroke();

    // √çcono central meditativo
    ctx.fillStyle = '#e9f0ff';
    ctx.font = `${Math.round(r*0.9)}px serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('üßò', x, y);
    ctx.restore();
  }

  function drawProjectile(p){
    const icon = p.kind==='danger' ? '‚ö†Ô∏è' : (p.kind==='bully' ? '‚ùó' : 'üí¨');
    const color = p.kind==='danger'? '#ff5252' : (p.kind==='bully' ? '#ff6f00' : '#9ca7c9');
    ctx.save();
    // burbuja / proyectil
    ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fillStyle = color; ctx.globalAlpha = 0.85; ctx.fill();
    ctx.globalAlpha = 1; ctx.lineWidth=2; ctx.strokeStyle = '#1b2242'; ctx.stroke();
    // icono
    ctx.font = `${Math.round(p.r*0.9)}px serif`;
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle = '#fff';
    ctx.fillText(icon, p.x, p.y-2);
    // texto peque√±o
    ctx.font = '12px system-ui'; ctx.fillStyle = '#0b1022';
    const tw = ctx.measureText(p.text).width;
    if(tw < p.r*2.2){ ctx.fillText(p.text, p.x, p.y+p.r+12); }
    ctx.restore();
  }

  function draw(){
    const w = canvas.clientWidth, h = canvas.clientHeight;
    ctx.clearRect(0,0,w,h);

    // L√≠nea de ataque superior decorativa
    ctx.save();
    ctx.strokeStyle = '#24306b'; ctx.setLineDash([6,6]); ctx.beginPath();
    ctx.moveTo(8, 36); ctx.lineTo(w-8, 36); ctx.stroke(); ctx.restore();

    // Jugador
    drawShieldBase();

    // Proyectiles
    State.projectiles.forEach(drawProjectile);
  }

  // ---------------------- L√≥gica / f√≠sica simple ----------------------
  function update(dt){
    if(!State.running || State.paused) return;
    State.elapsed += dt;

    // Spawning
    State.spawnTimer -= dt*1000;
    if(State.spawnTimer <= 0){
      if(State.mode==='campaign'){
        const cfg = WAVES[State.wave-1];
        const type = choice(cfg.types);
        // En intermedio y avanzado, el bully aparece como r√°faga a veces
        if(type==='bully' && !State.bullyActive && Math.random()<0.6){
          // Dispara una peque√±a r√°faga de 3-4 insultos
          const n = 3 + (Math.random()*2|0);
          for(let i=0;i<n;i++){
            setTimeout(()=>State.projectiles.push(makeProjectile('bully')), i*220);
          }
        } else {
          State.projectiles.push(makeProjectile(type));
        }
        State.spawnTimer = cfg.spawnEvery * rand(0.8,1.25);
      } else {
        // Infinito: probabilidad seg√∫n tiempo
        const r = Math.random();
        const type = r<0.6 ? 'taunt' : (r<0.85 ? 'bully' : 'danger');
        State.projectiles.push(makeProjectile(type));
        State.spawnTimer = Math.max(350, 1100 - State.elapsed*0.03);
      }
    }

    // Mover proyectiles
    const w = canvas.clientWidth, h = canvas.clientHeight;
    State.projectiles.forEach(p=>{ p.y += p.vy; });

    // Colisi√≥n con jugador (si llega al escudo sin respuesta => da√±o)
    for(const p of State.projectiles){
      if(!p.alive) continue;
      const dx = p.x-PLAYER.x, dy = p.y-PLAYER.y, dist = Math.hypot(dx,dy);
      if(dist < p.r + PLAYER.r*0.7){ // margen
        // Impacto no manejado: da√±o
        p.alive = false;
        applyDamage(18);
        impact();
        speak('¬°Tu calma recibi√≥ un golpe! ¬°Recuerda tus defensas!');
        flashCenter('¬°Ayyy! Escudo golpeado', 'Usa la defensa correcta', '#ff7676');
      }
    }

    // Limpiar muertos o fuera de pantalla
    State.projectiles = State.projectiles.filter(p=>p.alive && p.y < h+40);

    // Reglas de oleada (fin por tiempo)
    if(State.mode==='campaign'){
      const cfg = WAVES[State.wave-1];
      if(State.elapsed*1000 >= cfg.duration){
        // Si no hay proyectiles pendientes, avanza de oleada
        if(State.projectiles.length===0){ nextWave(); }
      }
    }
  }

  function applyDamage(amount){
    State.hp = clamp(State.hp - amount, 0, 100);
    updateHPUI();
    if(State.hp<=0) return endGame(false);
  }

  function updateHPUI(){
    hpBar.style.width = `${State.hp}%`;
    hpLabel.textContent = `${Math.round(State.hp)}%`;
  }

  function flashCenter(title, subtitle='', color='#cfe3ff'){
    centerMsg.innerHTML = `<div class="big" style="color:${color}">${title}</div>` + (subtitle?`<div class="mid">${subtitle}</div>`:'');
    centerMsg.style.opacity = '1';
    centerMsg.animate([{opacity:1},{opacity:0}],{duration:1400, easing:'ease', fill:'forwards'});
  }

  function updateMetricsUI(){
    metricsDiv.innerHTML = `üí® Ignoradas: <b>${State.metrics.ignored}</b> ¬∑ üõ°Ô∏è Bloqueados: <b>${State.metrics.blocked}</b> ¬∑ üö® Avisos: <b>${State.metrics.reported}</b> ¬∑ ‚ùå Errores: <b>${State.metrics.mistakes}</b><br/>Puntuaci√≥n: <b>${Math.round(State.score)}</b>`;
  }

  // ---------------------- Controles del jugador ----------------------
  function handleDefense(kind){
    if(!State.running || State.paused) return;
    // Encuentra el proyectil m√°s cercano al jugador (objetivo prioritario)
    let target = null, bestD=1e9;
    for(const p of State.projectiles){
      const d = Math.hypot(p.x-PLAYER.x, p.y-PLAYER.y);
      if(d < bestD){ bestD=d; target=p; }
    }
    if(!target) return; // nada que procesar

    function correctActionFor(p){
      if(p.kind==='taunt') return 'ignorar';
      if(p.kind==='bully') return 'bloquear';
      if(p.kind==='danger') return 'avisar';
    }

    const correct = correctActionFor(target);
    const wasCorrect = (kind===correct);

    if(wasCorrect){
      // Elimina (y reglas especiales para bully)
      target.alive=false;
      if(target.kind==='bully'){
        // Si hay varias en r√°faga, bloquear limpia cercanas del mismo tipo
        const removed = State.projectiles.filter(p=>p.kind==='bully' && p.alive && Math.abs(p.x-target.x)<60);
        removed.forEach(p=>p.alive=false);
        State.bullyActive = false;
      }
      // Feedback por tipo
      if(kind==='ignorar'){ wind(); speak('¬°Energ√≠a conservada! ¬°Esa burla no te afect√≥!'); State.metrics.ignored++; State.score+=25; flashCenter('‚úîÔ∏è Ignorado', '¬°Calma intacta!', '#7ee0b0'); }
      else if(kind==='bloquear'){ wall(); speak('¬°Paz restaurada! ¬°T√∫ controlas tu espacio!'); State.metrics.blocked++; State.score+=40; flashCenter('üõ°Ô∏è Bloqueado', 'Acoso detenido', '#ffd467'); }
      else { reinforcements(); speak('¬°La decisi√≥n m√°s valiente! ¬°Has protegido a todos!'); State.metrics.reported++; State.score+=60; flashCenter('üö® Aviso enviado', 'Adultos en camino', '#ffaaaa'); }
    } else {
      // Error => da√±o
      applyDamage(18);
      impact(); State.metrics.mistakes++; State.score=Math.max(0,State.score-10);
      speak('¬°Tu calma recibi√≥ un golpe! ¬°Recuerda tus defensas!');
      flashCenter('‚ùå Defensa incorrecta', 'Piensa cu√°l corresponde', '#ffa07a');
    }
    updateMetricsUI();
  }

  // ---------------------- Flujo de oleadas / modos ----------------------
  function startCampaign(){
    State.mode='campaign';
    State.wave=1; State.elapsed=0; State.spawnTimer=400; State.projectiles=[]; State.hp=100; State.score=0; State.metrics={ignored:0,blocked:0,reported:0,mistakes:0}; State.bullyActive=false;
    updateHPUI();
    waveNo.textContent = '1';
    statusText.textContent = `Nivel ${WAVES[0].name}`;
    State.running = true; State.paused=false;
    flashCenter('Oleada 1: Principiante', 'Responde con üí® Ignorar');
  }

  function nextWave(){
    if(State.wave>=3) return endGame(true);
    State.wave++; State.elapsed=0; State.spawnTimer=400; State.projectiles=[]; State.bullyActive=false;
    waveNo.textContent = String(State.wave);
    statusText.textContent = `Nivel ${WAVES[State.wave-1].name}`;
    flashCenter(`Oleada ${State.wave}: ${WAVES[State.wave-1].name}`, State.wave===2?'Aparece un acosador ‚Äî usa üõ°Ô∏è Bloquear':'Amenazas y solicitudes ‚Äî usa üö® Avisar');

    // Desbloqueos de skins
    if(State.wave===2){ unlockSkin('ice'); }
    if(State.wave===3){ unlockSkin('rose'); }
  }

  function endGame(victory){
    State.running=false; State.projectiles=[];
    const end = document.getElementById('endModal');
    const title = document.getElementById('endTitle');
    const body = document.getElementById('endBody');

    if(victory){
      title.textContent = 'üèÜ ¬°Victoria!';
      const msg = `¬°Misi√≥n Cumplida! Ignoraste <b>${State.metrics.ignored}</b> burlas, bloqueaste <b>${State.metrics.blocked}</b> acosadores y avisaste ante <b>${State.metrics.reported}</b> amenazas graves. ¬°Dominas la auto‚Äëprotecci√≥n digital!`;
      body.innerHTML = `${msg}<br><br>El Maestro te nombra: <b>Guardi√°n de la Serenidad</b>.`;
      speak('¬°Gran trabajo! Has protegido tu calma y la de todos.');
    } else {
      title.textContent = 'üí° Aprendizaje';
      body.innerHTML = `Tu escudo se rompi√≥ esta vez. Hablemos con el Maestro para aprender: recuerda <b>Ignorar</b> burlas, <b>Bloquear</b> el acoso y <b>Avisar</b> ante peligros. ¬°Int√©ntalo de nuevo!`;
      speak('Respira. Aprendimos algo nuevo. Int√©ntalo otra vez con calma.');
    }
    // Resumen m√©trico r√°pido
    body.innerHTML += `<hr style="border-color:#223077"/><div><b>Resumen</b>: üí® ${State.metrics.ignored} ¬∑ üõ°Ô∏è ${State.metrics.blocked} ¬∑ üö® ${State.metrics.reported} ¬∑ ‚ùå ${State.metrics.mistakes}</div>`;

    updateMetricsUI();
    end.showModal();
  }

  function startInfinite(){
    State.mode='infinite'; State.wave=0; State.elapsed=0; State.spawnTimer=400; State.projectiles=[]; State.hp=100; State.score=0; State.metrics={ignored:0,blocked:0,reported:0,mistakes:0}; State.bullyActive=false;
    updateHPUI(); waveNo.textContent='‚àû'; statusText.textContent='Avalancha Infinita';
    State.running=true; State.paused=false; flashCenter('üå™Ô∏è Avalancha Infinita', 'Velocidad creciente');
  }

  // ---------------------- Skins ----------------------
  function unlockSkin(key){
    State.unlocks[key]=true;
    const el = $(`.skin[data-skin="${key}"]`);
    if(el){ el.classList.remove('locked'); el.title='Desbloqueado'; }
  }
  function applySkin(key){
    if(key!=='base' && !State.unlocks[key]) return; // no aplicar si no est√° desbloqueada
    State.shieldSkin = key;
    flashCenter('üé® Nuevo escudo','¬°Listo!', '#cfe3ff');
  }

  skinGrid.addEventListener('click', (e)=>{
    const card = e.target.closest('.skin'); if(!card) return;
    const key = card.getAttribute('data-skin');
    applySkin(key);
  });

  // ---------------------- Bucle de animaci√≥n ----------------------
  let last = performance.now();
  function loop(now){
    const dt = (now-last)/1000; last = now;
    if(State.running && !State.paused){ update(dt); }
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // ---------------------- Entrada / Interacci√≥n ----------------------
  window.addEventListener('keydown',(e)=>{
    if(e.repeat) return;
    if(e.key==='1') handleDefense('ignorar');
    else if(e.key==='2') handleDefense('bloquear');
    else if(e.key==='3') handleDefense('avisar');
  });
  document.getElementById('btnIgnorar').addEventListener('click',()=>handleDefense('ignorar'));
  document.getElementById('btnBloquear').addEventListener('click',()=>handleDefense('bloquear'));
  document.getElementById('btnAvisar').addEventListener('click',()=>handleDefense('avisar'));

  // Botones header / briefing
  document.getElementById('btnAvalancha').addEventListener('click', startInfinite);
  document.getElementById('btnPausa').addEventListener('click', ()=>{ State.paused=!State.paused; flashCenter(State.paused?'‚è∏Ô∏è Pausa':'‚ñ∂Ô∏è Reanudar'); });
  document.getElementById('btnReiniciar').addEventListener('click', ()=>{ (State.mode==='infinite')? startInfinite() : startCampaign(); });
  document.getElementById('btnTutorial').addEventListener('click', ()=>$('#tutorial').showModal());

  // ---------------------- API p√∫blica para botones del modal ----------------------
  window.startGame = () => startCampaign();

  // Mostrar tutorial al entrar y primera l√≠nea de voz
  window.addEventListener('load',()=>{
    $('#tutorial').showModal();
    speak('Bienvenido. Usa Ignorar para burlas, Bloquear para acoso y Avisar para peligros. ¬°T√∫ controlas tu calma!');
  });

  // Mantener avatar centrado
  const ro = new ResizeObserver(()=>{ resetPlayerPos(); }); ro.observe(canvas);

})();
</script>
</body>
</html>
